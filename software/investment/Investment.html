{{ block content }}
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<div id="header">
    <table class="table top-table">
        <tr>
            <th class="left-aligned">Day {{player.round_number}} of {{100}}</th>
            <th class="centered"><span id="time-left"></span> Remaining</th>
            <th class="right-aligned">Earnings: {{payoff_usd}}</th>
        </tr>
    </table>
</div>
<input type="hidden" name="offer_actions" id="offer_actions" />
<input type="hidden" name="work_actions" id="work_actions" />
<canvas id="fx-canvas" aria-hidden="true"></canvas>
<div id="fx-banner" aria-live="polite"></div>

<h3>Job Offers</h3>
<table class="table  offer-section">
    <thead>
        <tr>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Length<br><span class="sub-heading">(Average [Range])</span></th>
            <th>Deadlines<br><span class="sub-heading">(Soft/Hard)</span></th>
            <th>Payment</th>
            <th>Rate</th>
            <th class="centered">Take Job?</th>
        </tr>
    </thead>
    <tbody>
        {{ for job in offer_strs }}
        <tr>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.lengths}}</td>
            <td>{{job.deadlines}}</td>
            <td>{{job.payment}}</td>
            <td>{{job.rate}}</td>
            <td class="centered">
                <input type="checkbox"
                       id="taking_checkbox{{job.name}}"
                       data-job-name="{{job.name}}"
                       onclick="toggleTaking('{{job.name}}', this.checked)"
                       >
            </td>
        </tr> {{ endfor }}
    </tbody>
</table>

<br><br><br>
<table class="table current-jobs-table">
    <tr>
        <td class="left-aligned h3-style">Current Jobs</td>
        <td class="right-aligned" id="workers-assigned">X/10 Workers assigned></td>
    </tr>
</table>
<table class="table work-section">
    <thead>
        <tr>
            <th></th>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Progress</th>
            <th>Length<br><span class="sub-heading">(Average [Range])</span></th>
            <th>Days Left<br><span class="sub-heading">(Soft/Hard)</span></th>
            <th>Payment</th>
            <th>Rate</th>
            <th class="centered">Work?</th>
            <th class="graph-column"></th>
        </tr>
    </thead>
    <tbody>
        {{ for job in job_strs }}
        <tr id="row_for_{{job.name}}">
            <td class="centered">{{job.status}}</td>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.progress_cur}}<span class="progress-text">{{job.progress_last}}</span></td>
            <td>{{job.lengths}}</td>
            <td {% if job.danger %}class="danger-text"{% endif %}">
                {{ job.deadlines }}
            </td>
            <td>{{job.payment}}<span class="penalty-text">{{job.penalty}}</span></td>
            <td>{{job.rate}}</td>
            <td class="centered">
                <input type="checkbox"
                       id="working_checkbox{{job.name}}"
                       data-job-name="{{job.name}}"
                       data-workers-required="{{job.workers}}"
                       onclick="toggleWorking('{{job.name}}', this.checked, '{{job.workers}}')"
                       >
            </td>
            <td class="sparkline-cell" id="sparkline{{job.name}}"></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<br><br>
{{if allow_submit}}
<input type="submit" class="otree-btn-next" value="Submit Early">
{{endif}}
{{if ended_strs}}
<h3>Ended Jobs</h3>
<table class="table">
    <thead>
        <tr>
            <th>Outcome</th>
            <th>Status</th>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Progress</th>
            <th class="centered">Payment</th>
        </tr>
    </thead>
    <tbody>
        {{ for job in ended_strs }}
        <tr>
            <td>{{job.status}}</td>
            <td>{{job.deadlines}}</td>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.progress_cur}}<span class="progress-text">{{job.progress_last}}</span></td>
            <td class="centered"><span class="earned-pay-text">{{job.payment}}</span><span class="lost-pay-text">{{job.penalty}}</span></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{{endif}}

<style>
 #header{
     top: 0px;
 }
 .current-jobs-table, .current-jobs-table td {
     font-size: 24px;
     font-weight: normal;
     border: none;
     padding: 0;
     margin-bottom: 5px;
 }
 .current-jobs-table td.h3-style {
     font-size: 1.17em; /* Common default size for h3 */
     /* font-weight: bold; /* h3 is usually bold */ */
     /* Add other h3 styles if needed */
 }
 .work-section th.graph-column,
 .work-section td.sparkline-cell {
     border-left: 1px solid #ccc; /* Adjust color as needed */
 }

 /* Left align the graph and remove margins */
 .work-section td.sparkline-cell {
     text-align: left;
     margin: 0;
     padding-left: 0; /* Removes padding if there's any */
}
 #workers-assigned {
     text-align: right;
 }
 .sub-heading {
     font-size: 16px;
     /* font-weight: normal; */
 }
 .work-section td.danger-text {
     color: red;
 }
 .progress-text {
     color: rgba(0,128,0,0.6);
 }
 .penalty-text {
     color: rgba(255, 0, 0, 0.5);
 }
 .lost-pay-text {
     color: red;
 }
 .earned-pay-text {
     color: green;
 }
 .otree-timer {
     display: none;
 }
 .top-table td, .top-table th {
     font-size: 24px; /* Adjust the size as needed */
 }
 .left-aligned {
     text-align: left;
 }
 thead th {
     vertical-align: middle;
     font-size: 18px;
 }
 .centered {
     text-align: center;
 }
 .right-aligned {
     text-align: right;
 }
 .highlight-disabled {
     background-color: #ffe3e3;
 }
 .highlight-selected {
     background-color: #faf9be;
 }
 input[type="checkbox"] {
     transform: scale(1.4); /* Adjust the scaling factor as needed */
 }
 .otree-btn-next {
     display: block; /* Makes the button a block-level element */
     margin-left: auto;
     margin-right: auto;
     transform: scale(1.4);
     background-color: lightgreen;
     color: black;
     border-radius: 5px;
     transition: background-color 0.3s ease;
     /* Other styles */
 }
 .table {
     width: 110%;
     table-layout: auto;
}
 .otree-btn-next:disabled {
     background-color: #cccccc; /* Gray background for disabled state */
     color: #666666; /* Darker text color to indicate it's disabled */
     cursor: not-allowed; /* Cursor indicates the button is not clickable */
     opacity: 0.5; /* Make the button appear faded */
}

 #fx-canvas {
     position: fixed;
     inset: 0;
     width: 100%;
     height: 100%;
     pointer-events: none;
     z-index: 999;
 }
 #fx-banner {
     position: fixed;
     top: 75px;
     right: 20px;
     z-index: 1000;
     font-family: "Courier New", monospace;
     font-weight: 700;
     letter-spacing: 1px;
     text-transform: uppercase;
     color: #fff;
     background: rgba(20, 20, 20, 0.88);
     border: 2px solid #fff;
     box-shadow: 0 0 0 2px #000;
     padding: 8px 12px;
     opacity: 0;
     transform: translateY(-8px);
     transition: opacity 0.2s ease, transform 0.2s ease;
 }
 #fx-banner.visible {
     opacity: 1;
     transform: translateY(0);
 }

</style>

<script>
 let totalWorkers = js_vars.workers;
 let jobs = js_vars.jobs;
 let workersUsed = 0;
 const feedbackEvents = {
     completionGain: {{ feedback_events.completion_gain }},
     completionCount: {{ feedback_events.completion_count }},
     failedLoss: {{ feedback_events.failed_loss }},
     failedCount: {{ feedback_events.failed_count }},
     lateLoss: {{ feedback_events.late_loss }},
     lateCount: {{ feedback_events.late_count }},
     dailyPenalty: {{ feedback_events.daily_penalty }},
 };

 function updateJobAccessibility() {
     const jobCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="working_checkbox"]');
     jobCheckboxes.forEach(checkbox => {
         const workersRequired = parseInt(checkbox.getAttribute('data-workers-required'));
         const jobId = checkbox.id.replace('working_checkbox', '');
         const jobRow = document.getElementById('row_for_' + jobId);
         const checked = checkbox.checked

         if (!checked && workersRequired > totalWorkers - workersUsed) {
             checkbox.disabled = true;
             jobRow.classList.add('highlight-disabled'); // Add a class to highlight
         } else {
             checkbox.disabled = false;
             jobRow.classList.remove('highlight-disabled');
         }
         if (checked) {
             jobRow.classList.add('highlight-selected');
         } else {
             jobRow.classList.remove('highlight-selected');
         }
     });
 }
 function updateWorkersAssigned() {
     document.getElementById('workers-assigned').textContent = `${workersUsed}/10 Workers assigned`;
 }
 function toggleWorking(jobId, isChecked, workersRequired) {
     workersRequired = parseInt(workersRequired);
     if (isChecked) {
         if (workersRequired <= totalWorkers - workersUsed) {
             workersUsed += workersRequired;
         } else {
             document.getElementById('working_checkbox' + jobId).checked = false;
             return;
         }
     } else {
         workersUsed -= workersRequired;
     }
     updateJobAccessibility();
     updateWorkActions()
     updateWorkersAssigned();
 }

 function toggleTaking(jobId, isChecked) {
     updateOfferActions();
 }

 function updateWorkActions() {
     let workActions = [];

     // For Work Actions
     document.querySelectorAll('.work-section input[type="checkbox"]').forEach(checkbox => {
         if (checkbox.checked) {
             workActions.push(checkbox.getAttribute('data-job-name'));
         }
     });

     // Update hidden inputs
     document.getElementById('work_actions').value = workActions.join(',');
 }

 function getAvailableWorkers() {
     return parseInt(document.getElementById('workers').textContent)
 }

 function updateOfferActions() {
     let offerActions = [];

     // For Offer Actions
     document.querySelectorAll('.offer-section input[type="checkbox"]').forEach(checkbox => {
         if (checkbox.checked) {
             offerActions.push(checkbox.getAttribute('data-job-name'));
         }
     });

     // Update hidden inputs
     document.getElementById('offer_actions').value = offerActions.join(',');
 }

 let customTimerEle = document.getElementById('time-left');
 document.addEventListener("DOMContentLoaded", function (event) {
     $('.otree-timer__time-left').on('update.countdown', function (event) {
         let timeString = "";

         const hours = event.offset.hours;
         const minutes = event.offset.minutes;
         const seconds = event.offset.seconds;

         if (hours > 0) {
             timeString += `${hours} hour${hours > 1 ? 's' : ''} `;
             if (minutes > 0) {
                 timeString += `${minutes} minute${minutes > 1 ? 's' : ''}`;
             }
         } else if (minutes > 0) {
             timeString += `${minutes} minute${minutes > 1 ? 's' : ''} `;
             if (seconds > 0) {
                 timeString += `${seconds} second${seconds > 1 ? 's' : ''}`;
             }
         } else {
             timeString += `${seconds} second${seconds > 1 ? 's' : ''}`;
         }

         customTimerEle.innerText = timeString.trim();
     });
 });
 // Function to draw sparklines with D3.js
 function drawSparklines(jobs) {
     jobs.forEach(function(job) {
         // Select the sparkline cell by ID and append an SVG
         var svg = d3.select('#sparkline' + job.name)
                     .append('svg')
                     .attr('width', 80) // Set the width of the SVG element
                     .attr('height', 10); // Set the height of the SVG element

         // Define the data for the sparkline
         var data = [job.lengthRange[0], job.lengthRange[1]];

         // Create a scale to fit the sparkline within the SVG
         var xScale = d3.scaleLinear()
                        .domain([0, 10])
                        .range([0, 80]);

         // Draw the line for the sparkline
         var line = d3.line()
                      .x(function(d, i) { return xScale(d); })
                      .y(function() { return 5; }); // Center the line in the SVG

         svg.append('path')
            .datum(data)
            .attr('d', line)
            .attr('stroke', 'black')
            .attr('stroke-width', 2);

         // Add a circle for the expected length
         svg.append('circle')
            .attr('cx', xScale(job.expectedLength))
            .attr('cy', 5)
            .attr('r', 3)
            .attr('fill', 'blue');
         if (!job.pastSoft) {
             svg.append('line')
                .attr('x1', xScale(job.softDeadline))
                .attr('y1', 0)
                .attr('x2', xScale(job.softDeadline))
                .attr('y2', 30) // Height of the SVG
                .attr('stroke', 'orange')
                .attr('stroke-width', 2);
         }

         // Draw the hard deadline line
         svg.append('line')
            .attr('x1', xScale(job.hardDeadline))
            .attr('y1', 0)
            .attr('x2', xScale(job.hardDeadline))
            .attr('y2', 30) // Height of the SVG
            .attr('stroke', 'red')
            .attr('stroke-width', 2);

     });
 }

 function showBanner(message, tone) {
     const banner = document.getElementById('fx-banner');
     banner.textContent = message;
     banner.style.borderColor = tone === 'good' ? '#68f59c' : '#ff8b8b';
     banner.style.color = tone === 'good' ? '#68f59c' : '#ff8b8b';
     banner.classList.add('visible');
     setTimeout(() => banner.classList.remove('visible'), 1200);
 }

 function playRetroTone(isGain) {
     const AudioCtx = window.AudioContext || window.webkitAudioContext;
     if (!AudioCtx) {
         return;
     }
     const ctx = new AudioCtx();
     const now = ctx.currentTime;
     const notes = isGain ? [523.25, 659.25, 783.99] : [329.63, 246.94, 196.00];
     notes.forEach((freq, index) => {
         const osc = ctx.createOscillator();
         const gain = ctx.createGain();
         osc.type = 'square';
         osc.frequency.value = freq;
         gain.gain.setValueAtTime(0.001, now + index * 0.07);
         gain.gain.exponentialRampToValueAtTime(0.12, now + index * 0.07 + 0.02);
         gain.gain.exponentialRampToValueAtTime(0.001, now + index * 0.07 + 0.14);
         osc.connect(gain).connect(ctx.destination);
         osc.start(now + index * 0.07);
         osc.stop(now + index * 0.07 + 0.15);
     });
     setTimeout(() => ctx.close(), 500);
 }

 function burstParticles(kind, count = 28) {
     const canvas = document.getElementById('fx-canvas');
     const ctx = canvas.getContext('2d');
     canvas.width = window.innerWidth;
     canvas.height = window.innerHeight;

     const colors = kind === 'gain'
         ? ['#00ff99', '#f8ff68', '#7ad7ff']
         : ['#ff5b5b', '#ffa24d', '#d466ff'];

     const particles = Array.from({ length: count }, () => ({
         x: canvas.width * (0.3 + Math.random() * 0.4),
         y: canvas.height * (0.28 + Math.random() * 0.32),
         dx: (Math.random() - 0.5) * 8,
         dy: (Math.random() - 0.5) * 8,
         life: 1,
         color: colors[Math.floor(Math.random() * colors.length)],
         size: 2 + Math.random() * 4,
     }));

     function animate() {
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         particles.forEach((p) => {
             p.x += p.dx;
             p.y += p.dy;
             p.dy += 0.12;
             p.life -= 0.025;
             ctx.globalAlpha = Math.max(0, p.life);
             ctx.fillStyle = p.color;
             ctx.fillRect(p.x, p.y, p.size, p.size);
         });
         if (particles.some((p) => p.life > 0)) {
             requestAnimationFrame(animate);
         } else {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
         }
     }

     animate();
 }

 function triggerFinancialFeedback() {
     if (feedbackEvents.completionGain > 0) {
         showBanner(`+ $${(feedbackEvents.completionGain / 100).toFixed(2)} Job payout!`, 'good');
         playRetroTone(true);
         burstParticles('gain', 40);
     }

     if (feedbackEvents.failedLoss > 0 || feedbackEvents.lateLoss > 0 || feedbackEvents.dailyPenalty > 0) {
         const totalLoss = feedbackEvents.failedLoss + feedbackEvents.lateLoss + feedbackEvents.dailyPenalty;
         setTimeout(() => {
             showBanner(`- $${(totalLoss / 100).toFixed(2)} Costs/Penalties`, 'bad');
             playRetroTone(false);
             burstParticles('loss', 34);
         }, feedbackEvents.completionGain > 0 ? 450 : 50);
     }
 }

 document.addEventListener("DOMContentLoaded", function () {
     let submitButton = document.querySelector('.otree-btn-next');
     if (submitButton) {
         const submitDelayMs = js_vars.submit_delay_ms;
         if (submitDelayMs > 0) {
             submitButton.disabled = true;
             setTimeout(() => {
                 submitButton.disabled = false;
             }, submitDelayMs);
         }
     }

     triggerFinancialFeedback();
 });

 // Initial call to set up job accessibility based on initial worker count
 updateJobAccessibility();
 updateWorkersAssigned();
 updateOfferActions();
 updateWorkActions();
 drawSparklines(jobs);
</script>
{{ endblock }}
