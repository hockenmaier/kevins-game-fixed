{{ block content }}
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<div id="header">
    <table class="table top-table">
        <tr>
            <th class="left-aligned">Day {{player.round_number}} of {{100}}</th>
            <th class="centered"><span id="time-left"></span> Remaining</th>
            <th class="right-aligned">Earnings: <span id="earnings-total" data-total-cents="{{ payoff_cents }}">{{payoff_usd}}</span> <span id="daily-penalty-chip"></span></th>
        </tr>
    </table>
</div>
<input type="hidden" name="offer_actions" id="offer_actions" />
<input type="hidden" name="work_actions" id="work_actions" />
<canvas id="fx-canvas" aria-hidden="true"></canvas>
<div id="fx-banner" aria-live="polite"></div>

<h3>Job Offers</h3>
<table class="table  offer-section">
    <thead>
        <tr>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Length<br><span class="sub-heading">(Average [Range])</span></th>
            <th>Deadlines<br><span class="sub-heading">(Soft/Hard)</span></th>
            <th>Payment</th>
            <th>Rate</th>
            <th class="centered">Take Job?</th>
        </tr>
    </thead>
    <tbody>
        {{ for job in offer_strs }}
        <tr>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.lengths}}</td>
            <td>{{job.deadlines}}</td>
            <td>{{job.payment}}</td>
            <td>{{job.rate}}</td>
            <td class="centered">
                <input type="checkbox"
                       id="taking_checkbox{{job.name}}"
                       data-job-name="{{job.name}}"
                       onclick="toggleTaking('{{job.name}}', this.checked)"
                       >
            </td>
        </tr> {{ endfor }}
    </tbody>
</table>

<br><br><br>
<table class="table current-jobs-table">
    <tr>
        <td class="left-aligned h3-style">Current Jobs</td>
        <td class="right-aligned" id="workers-assigned">X/10 Workers assigned></td>
    </tr>
</table>
<table class="table work-section">
    <thead>
        <tr>
            <th></th>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Progress</th>
            <th>Length<br><span class="sub-heading">(Average [Range])</span></th>
            <th>Days Left<br><span class="sub-heading">(Soft/Hard)</span></th>
            <th>Payment</th>
            <th>Rate</th>
            <th class="centered">Work?</th>
            <th class="graph-column"></th>
        </tr>
    </thead>
    <tbody>
        {{ for job in job_strs }}
        <tr id="row_for_{{job.name}}">
            <td class="centered">{{job.status}}</td>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.progress_cur}}<span class="progress-text">{{job.progress_last}}</span></td>
            <td>{{job.lengths}}</td>
            <td {% if job.danger %}class="danger-text"{% endif %}">
                {{ job.deadlines }}
            </td>
            <td>{{job.payment}}<span class="penalty-text">{{job.penalty}}</span></td>
            <td>{{job.rate}}</td>
            <td class="centered">
                <input type="checkbox"
                       id="working_checkbox{{job.name}}"
                       data-job-name="{{job.name}}"
                       data-workers-required="{{job.workers}}"
                       onclick="toggleWorking('{{job.name}}', this.checked, '{{job.workers}}')"
                       >
            </td>
            <td class="sparkline-cell" id="sparkline{{job.name}}"></td>
        </tr>
        {{ endfor }}
    </tbody>
</table>
<br><br>
{{if allow_submit}}
<input type="submit" class="otree-btn-next" value="Submit Early">
{{endif}}
{{if ended_strs}}
<h3>Ended Jobs</h3>
<table class="table">
    <thead>
        <tr>
            <th>Outcome</th>
            <th>Status</th>
            <th>ID</th>
            <th class="centered">Workers</th>
            <th>Progress</th>
            <th class="centered">Payment</th>
        </tr>
    </thead>
    <tbody>
        {{ for job in ended_strs }}
        <tr id="ended_row_{{job.name}}" class="{{if job.is_new}}{{else}}ended-historical{{endif}}">
            <td>{{job.status}}</td>
            <td>{{job.deadlines}}</td>
            <td>{{job.name}}</td>
            <td class="centered">{{job.workers}}</td>
            <td>{{job.progress_cur}}<span class="progress-text">{{job.progress_last}}</span></td>
            <td class="centered"><span class="earned-pay-text">{{job.payment}}</span><span class="lost-pay-text">{{job.penalty}}</span></td>
        </tr>
        {{ endfor }}
    </tbody>
</table>
{{endif}}

<style>
 #header{
     top: 0px;
 }
 .current-jobs-table, .current-jobs-table td {
     font-size: 24px;
     font-weight: normal;
     border: none;
     padding: 0;
     margin-bottom: 5px;
 }
 .current-jobs-table td.h3-style {
     font-size: 1.17em; /* Common default size for h3 */
     /* font-weight: bold; /* h3 is usually bold */ */
     /* Add other h3 styles if needed */
 }
 .work-section th.graph-column,
 .work-section td.sparkline-cell {
     border-left: 1px solid #ccc; /* Adjust color as needed */
 }

 /* Left align the graph and remove margins */
 .work-section td.sparkline-cell {
     text-align: left;
     margin: 0;
     padding-left: 0; /* Removes padding if there's any */
}
 #workers-assigned {
     text-align: right;
 }
 .sub-heading {
     font-size: 16px;
     /* font-weight: normal; */
 }
 .work-section td.danger-text {
     color: red;
 }
 .progress-text {
     color: rgba(0,128,0,0.6);
 }
 .penalty-text {
     color: rgba(255, 0, 0, 0.5);
 }
 .lost-pay-text {
     color: red;
 }
 .earned-pay-text {
     color: green;
 }
 .otree-timer {
     display: none;
 }
 .top-table td, .top-table th {
     font-size: 24px; /* Adjust the size as needed */
 }
 .left-aligned {
     text-align: left;
 }
 thead th {
     vertical-align: middle;
     font-size: 18px;
 }
 .centered {
     text-align: center;
 }
 .right-aligned {
     text-align: right;
 }
 .highlight-disabled {
     background-color: #ffe3e3;
 }
 .highlight-selected {
     background-color: #faf9be;
 }
 input[type="checkbox"] {
     transform: scale(1.4); /* Adjust the scaling factor as needed */
 }
 .otree-btn-next {
     display: block; /* Makes the button a block-level element */
     margin-left: auto;
     margin-right: auto;
     transform: scale(1.4);
     background-color: lightgreen;
     color: black;
     border-radius: 5px;
     transition: background-color 0.3s ease;
     /* Other styles */
 }
 .table {
     width: 110%;
     table-layout: auto;
}
 .otree-btn-next:disabled {
     background-color: #cccccc; /* Gray background for disabled state */
     color: #666666; /* Darker text color to indicate it's disabled */
     cursor: not-allowed; /* Cursor indicates the button is not clickable */
     opacity: 0.5; /* Make the button appear faded */
}

 #fx-canvas {
     position: fixed;
     inset: 0;
     width: 100%;
     height: 100%;
     pointer-events: none;
     z-index: 999;
 }
 #fx-banner {
     position: fixed;
     top: 75px;
     right: 20px;
     z-index: 1000;
     font-family: "Courier New", monospace;
     font-weight: 700;
     letter-spacing: 1px;
     text-transform: uppercase;
     color: #fff;
     background: rgba(20, 20, 20, 0.88);
     border: 2px solid #fff;
     box-shadow: 0 0 0 2px #000;
     padding: 8px 12px;
     opacity: 0;
     transform: translateY(-8px);
     transition: opacity 0.2s ease, transform 0.2s ease;
 }
 #fx-banner.visible {
     opacity: 1;
     transform: translateY(0);
 }


 .ended-historical {
     opacity: 0.52;
     filter: grayscale(0.25);
 }
 #earnings-total.flash-gain {
     animation: gainFlash 0.2s ease-in-out 4;
 }
 #earnings-total.flash-loss {
     animation: lossFlash 0.2s ease-in-out 4;
 }
 #daily-penalty-chip {
     display: inline-block;
     margin-left: 8px;
     color: #ff8b8b;
     font-weight: 700;
     font-family: "Courier New", monospace;
     opacity: 0;
 }
 #daily-penalty-chip.visible {
     opacity: 1;
 }
 #daily-penalty-chip.fly-in {
     animation: dailyFeeToTotal 0.5s ease-in-out forwards;
 }
 .money-fly {
     position: fixed;
     z-index: 4000;
     font-weight: 800;
     font-size: 28px;
     font-family: "Courier New", monospace;
     pointer-events: none;
     text-shadow: 0 2px 0 rgba(0,0,0,0.3);
 }
 @keyframes gainFlash {
     0%, 100% { color: inherit; }
     50% { color: #3dff93; }
 }
 @keyframes lossFlash {
     0%, 100% { color: inherit; }
     50% { color: #ff6d6d; }
 }
 @keyframes dailyFeeToTotal {
     0% { opacity: 1; transform: translateX(0); }
     100% { opacity: 0; transform: translateX(-26px); }
 }

</style>

<script>
 let totalWorkers = js_vars.workers;
 let jobs = js_vars.jobs;
 let workersUsed = 0;
 const feedbackEvents = {
     dailyPenalty: {{ feedback_events.daily_penalty }},
     jobEvents: [
         {{ for e in feedback_events.job_events }}
         { name: '{{e.name}}', cents: {{e.cents}}, kind: '{{e.kind}}' },
         {{ endfor }}
     ],
 };

 let animatedTotalCents = parseInt(document.getElementById('earnings-total').dataset.totalCents || '0');

 function setEarningsTotal(cents) {
     animatedTotalCents = cents;
     document.getElementById('earnings-total').textContent = `$${(cents / 100).toFixed(2)}`;
 }

 function updateJobAccessibility() {
     const jobCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="working_checkbox"]');
     jobCheckboxes.forEach(checkbox => {
         const workersRequired = parseInt(checkbox.getAttribute('data-workers-required'));
         const jobId = checkbox.id.replace('working_checkbox', '');
         const jobRow = document.getElementById('row_for_' + jobId);
         const checked = checkbox.checked

         if (!checked && workersRequired > totalWorkers - workersUsed) {
             checkbox.disabled = true;
             jobRow.classList.add('highlight-disabled'); // Add a class to highlight
         } else {
             checkbox.disabled = false;
             jobRow.classList.remove('highlight-disabled');
         }
         if (checked) {
             jobRow.classList.add('highlight-selected');
         } else {
             jobRow.classList.remove('highlight-selected');
         }
     });
 }
 function updateWorkersAssigned() {
     document.getElementById('workers-assigned').textContent = `${workersUsed}/10 Workers assigned`;
 }
 function toggleWorking(jobId, isChecked, workersRequired) {
     workersRequired = parseInt(workersRequired);
     if (isChecked) {
         if (workersRequired <= totalWorkers - workersUsed) {
             workersUsed += workersRequired;
         } else {
             document.getElementById('working_checkbox' + jobId).checked = false;
             return;
         }
     } else {
         workersUsed -= workersRequired;
     }
     updateJobAccessibility();
     updateWorkActions()
     updateWorkersAssigned();
 }

 function toggleTaking(jobId, isChecked) {
     updateOfferActions();
 }

 function updateWorkActions() {
     let workActions = [];

     // For Work Actions
     document.querySelectorAll('.work-section input[type="checkbox"]').forEach(checkbox => {
         if (checkbox.checked) {
             workActions.push(checkbox.getAttribute('data-job-name'));
         }
     });

     // Update hidden inputs
     document.getElementById('work_actions').value = workActions.join(',');
 }

 function getAvailableWorkers() {
     return parseInt(document.getElementById('workers').textContent)
 }

 function updateOfferActions() {
     let offerActions = [];

     // For Offer Actions
     document.querySelectorAll('.offer-section input[type="checkbox"]').forEach(checkbox => {
         if (checkbox.checked) {
             offerActions.push(checkbox.getAttribute('data-job-name'));
         }
     });

     // Update hidden inputs
     document.getElementById('offer_actions').value = offerActions.join(',');
 }

 let customTimerEle = document.getElementById('time-left');
 document.addEventListener("DOMContentLoaded", function (event) {
     $('.otree-timer__time-left').on('update.countdown', function (event) {
         let timeString = "";

         const hours = event.offset.hours;
         const minutes = event.offset.minutes;
         const seconds = event.offset.seconds;

         if (hours > 0) {
             timeString += `${hours} hour${hours > 1 ? 's' : ''} `;
             if (minutes > 0) {
                 timeString += `${minutes} minute${minutes > 1 ? 's' : ''}`;
             }
         } else if (minutes > 0) {
             timeString += `${minutes} minute${minutes > 1 ? 's' : ''} `;
             if (seconds > 0) {
                 timeString += `${seconds} second${seconds > 1 ? 's' : ''}`;
             }
         } else {
             timeString += `${seconds} second${seconds > 1 ? 's' : ''}`;
         }

         customTimerEle.innerText = timeString.trim();
     });
 });
 // Function to draw sparklines with D3.js
 function drawSparklines(jobs) {
     jobs.forEach(function(job) {
         // Select the sparkline cell by ID and append an SVG
         var svg = d3.select('#sparkline' + job.name)
                     .append('svg')
                     .attr('width', 80) // Set the width of the SVG element
                     .attr('height', 10); // Set the height of the SVG element

         // Define the data for the sparkline
         var data = [job.lengthRange[0], job.lengthRange[1]];

         // Create a scale to fit the sparkline within the SVG
         var xScale = d3.scaleLinear()
                        .domain([0, 10])
                        .range([0, 80]);

         // Draw the line for the sparkline
         var line = d3.line()
                      .x(function(d, i) { return xScale(d); })
                      .y(function() { return 5; }); // Center the line in the SVG

         svg.append('path')
            .datum(data)
            .attr('d', line)
            .attr('stroke', 'black')
            .attr('stroke-width', 2);

         // Add a circle for the expected length
         svg.append('circle')
            .attr('cx', xScale(job.expectedLength))
            .attr('cy', 5)
            .attr('r', 3)
            .attr('fill', 'blue');
         if (!job.pastSoft) {
             svg.append('line')
                .attr('x1', xScale(job.softDeadline))
                .attr('y1', 0)
                .attr('x2', xScale(job.softDeadline))
                .attr('y2', 30) // Height of the SVG
                .attr('stroke', 'orange')
                .attr('stroke-width', 2);
         }

         // Draw the hard deadline line
         svg.append('line')
            .attr('x1', xScale(job.hardDeadline))
            .attr('y1', 0)
            .attr('x2', xScale(job.hardDeadline))
            .attr('y2', 30) // Height of the SVG
            .attr('stroke', 'red')
            .attr('stroke-width', 2);

     });
 }

 function showBanner(message, tone) {
     const banner = document.getElementById('fx-banner');
     banner.textContent = message;
     banner.style.borderColor = tone === 'good' ? '#68f59c' : '#ff8b8b';
     banner.style.color = tone === 'good' ? '#68f59c' : '#ff8b8b';
     banner.classList.add('visible');
     setTimeout(() => banner.classList.remove('visible'), 1200);
 }

 function playRetroTone(pattern) {
     const AudioCtx = window.AudioContext || window.webkitAudioContext;
     if (!AudioCtx) {
         return;
     }
     const ctx = new AudioCtx();
     const now = ctx.currentTime;
     const notesByPattern = {
         gain: [523.25, 659.25, 783.99],
         dailyLoss: [196.00],
         jobLoss: [220.00, 185.00, 146.00, 98.00],
     };
     const notes = notesByPattern[pattern] || notesByPattern.gain;
     notes.forEach((freq, index) => {
         const osc = ctx.createOscillator();
         const gain = ctx.createGain();
         osc.type = 'square';
         osc.frequency.value = freq;
         gain.gain.setValueAtTime(0.001, now + index * 0.09);
         gain.gain.exponentialRampToValueAtTime(0.14, now + index * 0.09 + 0.02);
         gain.gain.exponentialRampToValueAtTime(0.001, now + index * 0.09 + 0.16);
         osc.connect(gain).connect(ctx.destination);
         osc.start(now + index * 0.09);
         osc.stop(now + index * 0.09 + 0.18);
     });
     setTimeout(() => ctx.close(), 900);
 }

 function burstParticlesAt(kind, x, y, count = 20) {
     const canvas = document.getElementById('fx-canvas');
     const ctx = canvas.getContext('2d');
     canvas.width = window.innerWidth;
     canvas.height = window.innerHeight;

     const colors = kind === 'gain'
         ? ['#00ff99', '#f8ff68', '#7ad7ff']
         : (kind === 'dailyLoss' ? ['#ff9090', '#ffcc88'] : ['#ff2b2b', '#ff9900', '#d466ff']);

     const spread = kind === 'jobLoss' ? 12 : 6;
     const gravity = kind === 'jobLoss' ? 0.18 : 0.08;

     const particles = Array.from({ length: count }, () => ({
         x,
         y,
         dx: (Math.random() - 0.5) * spread,
         dy: (Math.random() - 0.5) * spread,
         life: 1,
         color: colors[Math.floor(Math.random() * colors.length)],
         size: (kind === 'jobLoss' ? 3 : 2) + Math.random() * 4,
     }));

     function animate() {
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         particles.forEach((p) => {
             p.x += p.dx;
             p.y += p.dy;
             p.dy += gravity;
             p.life -= 0.03;
             ctx.globalAlpha = Math.max(0, p.life);
             ctx.fillStyle = p.color;
             ctx.fillRect(p.x, p.y, p.size, p.size);
         });
         if (particles.some((p) => p.life > 0)) {
             requestAnimationFrame(animate);
         } else {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
         }
     }

     animate();
 }

 function formatUsdFromCents(cents) {
     const abs = Math.abs(cents) / 100;
     return `$${abs.toFixed(2)}`;
 }

 function flashEarnings(isGain) {
     const totalEl = document.getElementById('earnings-total');
     totalEl.classList.remove('flash-gain', 'flash-loss');
     totalEl.classList.add(isGain ? 'flash-gain' : 'flash-loss');
     setTimeout(() => totalEl.classList.remove('flash-gain', 'flash-loss'), 1000);
 }

 function animateMoneyToTotal({ amountCents, signedCents, fromElement, isGain }) {
     if (!fromElement || !amountCents) {
         return Promise.resolve();
     }

     const totalEl = document.getElementById('earnings-total');
     const start = fromElement.getBoundingClientRect();
     const end = totalEl.getBoundingClientRect();

     const fly = document.createElement('div');
     fly.className = 'money-fly';
     fly.style.color = isGain ? '#24d870' : '#ff5757';
     fly.textContent = `${isGain ? '+' : '-'}${formatUsdFromCents(amountCents)}`;
     document.body.appendChild(fly);

     const sx = start.left + start.width / 2;
     const sy = start.top + start.height / 2;
     const ex = end.left + end.width / 2;
     const ey = end.top + end.height / 2;

     fly.style.left = `${sx}px`;
     fly.style.top = `${sy}px`;

     const angle = Math.PI / 6; // 30 degrees
     const controlLen = 160;
     const controlX = sx + Math.cos(angle) * controlLen;
     const controlY = sy - Math.sin(angle) * controlLen;
     const duration = 1500;
     const begin = performance.now();

     return new Promise((resolve) => {
         function step(now) {
             const rawT = Math.min(1, (now - begin) / duration);
             const t = 0.5 - 0.5 * Math.cos(Math.PI * rawT); // sine in/out easing
             const omt = 1 - t;
             const x = omt * omt * sx + 2 * omt * t * controlX + t * t * ex;
             const y = omt * omt * sy + 2 * omt * t * controlY + t * t * ey;
             fly.style.left = `${x}px`;
             fly.style.top = `${y}px`;
             fly.style.opacity = `${1 - rawT * 0.15}`;

             if (rawT < 1) {
                 requestAnimationFrame(step);
             } else {
                 fly.remove();
                 setEarningsTotal(animatedTotalCents + signedCents);
                 flashEarnings(isGain);
                 resolve();
             }
         }
         requestAnimationFrame(step);
     });
 }

 async function applyDailyPenaltyFeedback() {
     if (!feedbackEvents.dailyPenalty) {
         return;
     }
     const chip = document.getElementById('daily-penalty-chip');
     chip.textContent = `-${formatUsdFromCents(feedbackEvents.dailyPenalty)}`;
     chip.classList.add('visible', 'fly-in');

     const totalEl = document.getElementById('earnings-total');
     const totalRect = totalEl.getBoundingClientRect();
     burstParticlesAt('dailyLoss', totalRect.right + 8, totalRect.top + 12, 10);
     playRetroTone('dailyLoss');

     await new Promise((resolve) => setTimeout(resolve, 500));

     setEarningsTotal(animatedTotalCents - feedbackEvents.dailyPenalty);
     flashEarnings(false);

     chip.classList.remove('visible', 'fly-in');
     chip.textContent = '';
 }

 async function triggerFinancialFeedback() {
     const totalJobImpact = feedbackEvents.jobEvents.reduce((sum, evt) => sum + evt.cents, 0);
     setEarningsTotal(animatedTotalCents - feedbackEvents.dailyPenalty - totalJobImpact);

     await applyDailyPenaltyFeedback();

     if (!feedbackEvents.jobEvents.length) {
         return;
     }

     await new Promise((resolve) => setTimeout(resolve, 1000));

     for (const evt of feedbackEvents.jobEvents) {
         const row = document.getElementById(`ended_row_${evt.name}`);
         if (!row) {
             continue;
         }

         const paymentCell = row.querySelector('td:last-child');
         const isGain = evt.cents > 0;
         const amount = Math.abs(evt.cents);

         if (evt.kind === 'failed') {
             const rect = row.getBoundingClientRect();
             burstParticlesAt('jobLoss', rect.left + rect.width * 0.75, rect.top + rect.height / 2, 52);
             playRetroTone('jobLoss');
             showBanner(`Hard deadline miss on ${evt.name}: -${formatUsdFromCents(amount)}`, 'bad');
         } else if (evt.kind === 'late') {
             const rect = row.getBoundingClientRect();
             burstParticlesAt('dailyLoss', rect.left + rect.width * 0.75, rect.top + rect.height / 2, 20);
             playRetroTone('dailyLoss');
             showBanner(`${evt.name} paid late: +${formatUsdFromCents(amount)}`, 'good');
         } else {
             playRetroTone('gain');
             burstParticlesAt('gain', paymentCell.getBoundingClientRect().left, paymentCell.getBoundingClientRect().top, 26);
             showBanner(`Completed ${evt.name}: +${formatUsdFromCents(amount)}`, 'good');
         }

         await animateMoneyToTotal({
             amountCents: amount,
             signedCents: evt.cents,
             fromElement: paymentCell,
             isGain,
         });
     }
 }

 document.addEventListener("DOMContentLoaded", function () {
     let submitButton = document.querySelector('.otree-btn-next');
     if (submitButton) {
         const submitDelayMs = js_vars.submit_delay_ms;
         if (submitDelayMs > 0) {
             submitButton.disabled = true;
             setTimeout(() => {
                 submitButton.disabled = false;
             }, submitDelayMs);
         }
     }

     triggerFinancialFeedback();
 });

 // Initial call to set up job accessibility based on initial worker count
 updateJobAccessibility();
 updateWorkersAssigned();
 updateOfferActions();
 updateWorkActions();
 drawSparklines(jobs);
</script>
{{ endblock }}
